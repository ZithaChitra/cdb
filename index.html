<!DOCTYPE html>
<html>
<head>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <title> CDB GUI</title>
</head>
<body class="bg-gray-900 text-white">
    <h1 class="text-center p-5 mb-5 text-3xl font-bold">
      Chitra's Debugger
      </h1>
    <div class="grid grid-cols-12">
        <div class="mb-5 p-5 col-span-8">
            <div>
                <div>
                    <label for=""> proc path</label>
                    <input type="text" id="procpath" class="mb-2 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5  " placeholder="process path" required />
                </div>
                
                <div>
                    <label for=""> PID to Debug</label>
                    <input type="text" id="pidInput" class="mb-2 bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full ps-10 p-2.5  " placeholder="process id" required />
                </div>
            </div>

            <div class="flex">
                <button id="startDbgBtn" type="button" class="bg-blue-500 p-1 mr-2 rounded text-white flex items-center">
                    start debugging
                </button>
                <button id="getRegsBtn" type="button" class="bg-blue-500 p-1 mr-2 rounded text-white flex items-center">
                    Get Regs
                </button>
                <button id="nextBtn" type="button" class="bg-blue-500 p-1 mr-2 rounded text-white flex items-center">
                    Next i
                </button>
                <button id="allFuncsBtn" type="button" class="bg-blue-500 p-1 mr-2 rounded text-white flex items-center">
                    All Funcs
                </button>
                <button id="readMemBtn"  type="button" class="bg-blue-500 p-1 rounded text-white flex items-center">
                    Read Mem
                </button>
            </div>
            <div class=" md:grid grid-cols-12 gap-2">
                <div class="col-span-6">
                    <label for="message" class="block mb-2 text-sm font-medium text-gray-900 ">Server Command</label>
                    <textarea id="svrMsgInput" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 " 
                        placeholder="insert server command"></textarea>
                    <button onclick="sendMessage()">
                        Send Message</button>
                </div>
                <div class="col-span-5">
                    <label for="message" class="block mb-2 text-sm font-medium text-gray-900 ">Server Response</label>
                    <textarea id="svrMsgResp" rows="4" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 " 
                        placeholder=" server response"></textarea>
                </div>
            </div>
        </div>
        <div class="col-span-4">
            <div class="border rounded p-1">
                <h3 class="mb-2">Registers</h3>
                <div x-data >
                    <template 
                        x-for="(reg, key) in $store.proc.regs">
                        <div class="grid grid-cols-6">
                            <p class="col-span-2" x-text="key"></p>
                            <p class="col-span-4 border" x-text="reg"></p>
                        </div>
                </template>
                </div>
            </div>
            <div class="border rounded p-1">
                <h3 class="mb-2">All Functions</h3>
                <div x-data>
                    <template
                        x-for="(func, key) in $store.proc.funcs">
                        <div class="grid grid-cols-6">
                            <p class="col-span-2" x-text="func.func_name"></p>
                            <p class="col-span-4 border" x-text="func.low_pc"></p>
                        </div>
                    </template>
                </div>

            </div>
        </div>
    </div>


    <script>
        const svrMsgInput   = document.getElementById('svrMsgInput');
        const svrMsgResp    = document.getElementById('svrMsgResp');
        const pidInput      = document.getElementById('pidInput');
        const procpathIpt   = document.getElementById('procpath');
        const getRegsBtn    = document.getElementById('getRegsBtn');
        const readMemBtn    = document.getElementById('readMemBtn');
        const startDbgBtn   = document.getElementById('startDbgBtn');
        const nextBtn       = document.getElementById('nextBtn');
        const allFuncsBtn   = document.getElementById('allFuncsBtn');

        const actions = {
            PROC_START_DBG          : 0,             // - 0
            PROC_END_DBG            : 1,             // - 1
            PROC_REGS_READ          : 2,             // - 2
            PROC_REGS_WRITE         : 3,             // - 3
            PROC_MEM_READ           : 4,             // - 4
            PROC_MEM_WRITE          : 5,             // - 5
            PROC_STEP_SINGLE        : 6,             // - 6
            PROC_FUNC_ALL           : 7,             // - 7
            PROC_FUNC_SINGLE        : 8,             // - 8
            UNKNOWN_ACTION          : 9,             // - 9
        }
        const msg_handlers = [
            proc_start_dbg,
            proc_end_dbg,
            proc_regs_read,
            proc_regs_write,
            proc_mem_read,
            proc_mem_write,
            proc_step_single,
            proc_func_all,
            proc_func_single
        ];

        let isConnected     = false;
        let proc = {};


        document.addEventListener('alpine:init', () => {
            console.log('alpine initiatedc');
            Alpine.store('proc', {
                pid: null,
                regs: {"rax": "0980980"},
                funcs: {},
                mem: {
                    buffer:     [],
                    col_keys:   [],
                },

                update_regs: (regs) => {
                    console.log("update_regs: start------");
                    console.log("update_regs: end------");
                },
            })
            proc = Alpine.store('proc');
            proc.pid = 99;
        })

        const ws = new WebSocket("ws://localhost:8080");

        ws.onopen = function() {
            console.log("Connection opened");
            isConnected = true;
        };
        ws.onmessage = function(event) {
            // console.log(event);
            svrMsgResp.innerText = event.data
            try {
                const isObject = typeof event.data == "object";
                event = isObject ? event.data : JSON.parse(event.data)
                console.log("parsed data: ", event);
                if('actid' in event){
                    const handler = msg_handlers[event['actid']];
                    console.log(handler);
                    handler(event);
                }
                console.log(event);
            } catch (error) {
                console.log("Received data not parsed: ", error);
            }
        };

        ws.onclose = function() {
            console.log("Connection closed");
            isConnected = false;
        };

        getRegsBtn.onclick  = () => proc_regs_read();
        readMemBtn.onclick  = () => proc_mem_read();
        startDbgBtn.onclick = () => proc_start_dbg();
        nextBtn.onclick     = () => proc_step_single();
        allFuncsBtn.onclick = () => proc_func_all();

        function proc_start_dbg(event = null)
        {
            if(!event)
            {
                const path = procpathIpt.value;
                if(path && isConnected)
                {
                    const command = JSON.stringify({
                        "actid": actions.PROC_START_DBG,
                        "args": {
                            "path": "demo" 
                        }
                    })
                    // console.log("sending args: ", command);
                    ws.send(command);
                }else{
                    // console.log('pid not provided');
                }
                return;
            }
            if('resp' in event && 'pid' in event['resp'])
            {
                proc.pid = event['resp']['pid'];
                // console.log("pid set: ", proc);
            }
        }

        function proc_end_dbg()
        {

        }


        function proc_step_single(event = null)
        {
            if(!event)
            {
                const pid = proc.pid;
                if(pid && isConnected)
                {
                    const command = JSON.stringify({
                        "actid": actions.PROC_STEP_SINGLE,
                        "args": {
                            "pid":  parseInt(pid) 
                        }
                    })
                    // console.log("sending args: ", command);
                    ws.send(command);
                }else{
                    console.log('pid not provided');
                }
                return;
            }  
            console.log('proc_step_single');
            if('resp' in event && 'regs' in event['resp'])
            {
                console.log('handling new regs');
                proc.regs = event['resp']['regs'];
            }
        }


        function proc_regs_read(event = null)
        {
            if(!event)
            {
                const pid = proc.pid;
                if(pid && isConnected)
                {
                    const command = JSON.stringify({
                        "actid": actions.PROC_REGS_READ,
                        "args": {
                            "pid":  parseInt(pid) 
                        }
                    })
                    console.log("sending args: ", command);
                    ws.send(command);
                }else{
                    console.log('pid not provided');
                }
                return;
            }
            if('resp' in event && 'regs' in event['resp'])
            {
                proc.regs = event['resp']['regs'];
                console.log("regs: ", proc);
            }

        }

        function proc_regs_write()
        {

        }

        function base64ToUint8Array(base64) 
        {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            // return bytes;
            const hexArray = [];
            for (const byte of bytes) {
                const hex = byte.toString(16).padStart(2, '0');
                hexArray.push(hex);
            }

            return hexArray;
        }

        function mem_row_keys(total, col_max = 16)
        {
            console.log(`total: ${total}, col_max: ${col_max}`);
            if(col_max > total) return [{
                col_start: 0,
                col_end: total
            }]
            let keys = [];
            const rows_max = Math.ceil(total / col_max);
            let start_index = 0, end_index = start_index + (col_max - 1); 
            for(let i = 0; i < rows_max; i++)
            {
                keys.push({
                    col_start: start_index,
                    col_end: end_index
                });
                start_index = end_index + 1;
                end_index = start_index + col_max;
            }
            return keys;
        }

        function proc_mem_read(event = null)
        {
            if(!event)
            {
                const pid = proc.pid;
                if(pid && isConnected)
                {
                    const command = JSON.stringify({
                        "actid": actions.PROC_MEM_READ,
                        "args": {
                            "pid":  parseInt(pid) 
                        }
                    })
                    console.log("sending args: ", command);
                    ws.send(command);
                }else{
                    console.log('pid not provided');
                }
                return;
            }
            if('resp' in event && 'mem' in event['resp'])
            {
                const mem = event['resp']['mem'];
                const len = event['resp']['len'];
                const bytes_arr   = base64ToUint8Array(mem);
                const keys        = mem_row_keys(len)
                proc.mem.buffer   = bytes_arr;
                proc.mem.col_keys = keys;
                console.log("mem[]: ", mem);
                console.log("bytes[]: ", bytes_arr);
                console.log("keys[]: ", keys);
            }
        }

        function proc_mem_write()
        {

        }


        function proc_func_all(event = null)
        {
            if(!event)
            {
                const pid = proc.pid;
                if(pid && isConnected)
                {
                    const command = JSON.stringify({
                        "actid": actions.PROC_FUNC_ALL,
                        "args": {
                            "pid":  parseInt(pid) 
                        }
                    })
                    console.log("sending args: ", command);
                    ws.send(command);
                }else{
                    console.log('pid not provided');
                }
                return;
            }
            if('resp' in event && 'funcs' in event['resp'])
            {
                console.log("setting funcs handler");
                const funcs = event['resp']['funcs'];
                proc.funcs = funcs;
                console.log("all funcs: ", funcs);
            }else{
                console.log("invalid args");
            }
        }
        function proc_func_single()
        {

        }

        
        function sendMessage() {
            if (ws.readyState === WebSocket.OPEN) {
                console.log(svrMsgInput.value);
                const message = {
                    "actid": 0,
                    "args": {
                        "pid": 0
                    }
                }
                if(message){
                    ws.send(JSON.stringify(message));
                }else{
                    ws.send("Default test message");
                }
            }
        }
    </script>
</body>
</html>
